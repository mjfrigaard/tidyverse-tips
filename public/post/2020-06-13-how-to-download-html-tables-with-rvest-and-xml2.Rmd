---
title: How to download html tables with rvest and xml2
author: Martin Frigaard
date: '2020-06-13'
slug: how-to-split-and-tidy-column-contents
categories:
  - wrangle
tags:
  - rstats
---

```{r pkgs, eval=TRUE, message=FALSE, warning=FALSE, echo=FALSE}
library(methods)
library(magrittr)
library(ggthemes)
library(extrafont)
library(gridExtra)
library(wesanderson)
library(tidytext)
```


[Mark Berman](https://twitter.com/MarkBermanFox26) recently tweeted his interview with [Ginny Finch](https://twitter.com/GinnyFuchsUSA), 2016 USA Olympic Boxing team member:

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">USADA told Houston Olympic boxer <a href="https://twitter.com/GinnyFuchsUSA?ref_src=twsrc%5Etfw">@GinnyFuchsUSA</a>,who tested positive for prohibited substance,was determined to have been ingested by her(unprotected sex)without fault or negligence&amp;won’t face ineligibility.USA Boxing told Fuchs the USADA sanction of”No Fault”is the proper outcome <a href="https://t.co/ez0gkS7fah">pic.twitter.com/ez0gkS7fah</a></p>&mdash; Mark Berman (@MarkBermanFox26) <a href="https://twitter.com/MarkBermanFox26/status/1270931237847404545?ref_src=twsrc%5Etfw">June 11, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

According to [insidehook](https://www.insidehook.com/daily_brief/sports/sex-clears-olympic-boxer-virginia-fuchs-doping), Fuch tested positive for [Letrozole](https://en.wikipedia.org/wiki/Letrozole) and [GW501516](https://en.wikipedia.org/wiki/GW501516), two drugs listed as "Hormone and Metabolic Modulators" on the [World Anti-Doping Agency (WADA) Prohibited List](https://www.wada-ama.org/en/content/what-is-prohibited).

## How many postive tests without negative consequences?

In post on their [website](https://www.usada.org/sanction/virginia-fuchs-found-not-at-fault/), USADA determined Fuch was not at fault, and would not face any time of ineligibility:

> *USADA determined that Fuchs' male partner was using therapeutic doses of letrozole and GW1516 and the low amounts of letrozole metabolite and GW1516 metabolites detected in her sample were consistent with recent exposure to the substances via sexual transmission. Additionally, a WADA-accredited laboratory confirmed that products possessed by Fuchs' partner contained therapeutic amounts of letrozole and GW1516.*

Fuch's case got me wondering how many athletes have had positive test results and had their athletic careers continue uninterrupted. 
I decided I would download the USADA data see for myself. 

## The Data 

The USADA sanction data is available on the [USADA website](https://www.usada.org/news/sanctions/). 

![](/post/2020-06-13-how-to-download-html-tables-with-rvest-and-xml2_files/usada-sanctions.png){width=100%}

It's a searchable database in the browser, but I want to download this into R so I can wrangle and visualize it.

In order to extract data from the website, I'll be using the [`rvest` package](https://cran.r-project.org/web/packages/rvest/index.html) written by Hadley Wickham to scrape the `html` code. The code chunk below loads the packages needed to reproduce the graphics. 

```{r packages, message=FALSE, warning=FALSE, eval=TRUE}
library(tidyverse)
library(rvest)
library(xml2)
library(janitor)
library(ggrepel)
```

### Scraping the USADA website

The website for these data is available [here](https://tinyurl.com/yc346fq5). The `rvest::read_html()` and `rvest::html_nodes()` functions extract the content from the table in the Web page and translates it from HTML into a data frame.

```{r read_html_USADA, eval=TRUE, message=FALSE, warning=FALSE}
USADA_url <- "https://www.usada.org/testing/results/sanctions/"
USADA_extraction <- USADA_url %>%
     xml2::read_html() %>%
     rvest::html_nodes("table")
```

> **Store and explore*** refers to storing an output of a call to an object, then checking the contents of that new object. This is a great way to get to know R, objet-oriented programming, and how functions work together in packages. 

### Check the structure of the extraction

Look at the structure of `USADA_extraction`.

```{r USADA_extraction_str, eval=TRUE}
# check the structure of the new USADA_extraction object
USADA_extraction %>% utils::str()
```

This contains a `node` and a `doc` in a `List`.

### Check the class of the extraction

If I check the class of the list we extracted, we find...

```{r USADA_extraction_class, eval=TRUE}
USADA_extraction %>% class()
```

...this is an `xml_nodeset` with 2 lists (stored within the 1 list). After a little bit of exploration, I find the `table id` in the `html_node`.

```{r html_node}
USADA_extraction[[1]]
```

Now I know the data I want from this object is in position `[[1]]` of this list. 

### Ha`rvest` the html table

I can subset the `USADA_extraction` list with the `rvest::html_table()` function and store the table contents in the `UsadaRaw` object. I check my work using the `dplyr::glimpse(70)`.

```{r UsadaRaw, eval=TRUE}
UsadaRaw <- rvest::html_table(USADA_extraction[[1]])
UsadaRaw %>% dplyr::glimpse(70)
```

> why `dplyr::glimpse(70)`? It prints less to the screen and keeps the col width to <80, which is nice for working in plain text.

This reveals a data frame with `r nrow(UsadaRaw)` observations. The contents from the HTML list (`USADA_extraction`) has been converted to a data frame (`UsadaRaw`). I'm going to store this data frame as a .csv in a `data/raw` folder (so I don't have to scrape it every time I run this script). 

```{r raw_data_path, eval=TRUE}
# create raw data path
fs::dir_create("data/raw/")
# export the .csv file
write_csv(as.data.frame(UsadaRaw), 
          base::paste0("data/raw/",
                       base::noquote(lubridate::today()),
                           "-UsadaRaw.csv"))
```

### Wrangle the sanctions and substance/reason

The `clean_names()` function from the [`janitor`](https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html) package lets me quickly format all of the column names in the `UsadaRaw` data frame. This function has a `case` argument that allows me to select how I want to format the column names.

The [`purrr`](https://purrr.tidyverse.org/) package is excellent for iteration and functional programming. Both of these topics are too large to cover in this post, but I will demonstrate an example with the `purrr::map_df()` function:

`purrr::map_df()` takes a data frame (`.x`) and in input, and applies a function (`.f`) across it.

```{r clean-names, message=FALSE, warning=FALSE}
Usada <- UsadaRaw %>% janitor::clean_names(case = "snake")
# lowercase text -----
Usada <- purrr::map_df(.x = Usada, .f = stringr::str_to_lower)
utils::head(Usada)
```

## Filter out the "no fault or negligence" sanction terms

Now I need to identify the athletes with the `no fault or negligence` outcome in the `sanction_terms` column. I can do this with [`dplyr::filter()`](https://dplyr.tidyverse.org/reference/filter.html) and [`stringr::str_detect()`](https://stringr.tidyverse.org/reference/str_detect.html).

I also need to clean up the track and field responses in the `sport` column with some help from [`dplyr::mutate()`](https://dplyr.tidyverse.org/reference/mutate.html) and [`stringr::str_replace_all()`](https://stringr.tidyverse.org/reference/str_replace.html).

I will get a quick count and visualize these with 

```{r UsadaNoFaults}
UsadaNoFaults <- Usada %>% 
  dplyr::filter(stringr::str_detect(string = sanction_terms, 
                                    pattern = "^no fault or negligence$")) %>% 
                                      # replace & with and
  dplyr::mutate(sport = stringr::str_replace_all(string = sport, 
                                         # replace this
                                       pattern = "&", 
                                         # with this
                                       replacement = "and"))
```

## Graph sanction terms and substances

Now we can create a quick graph of the most common `no fault or negligence` sanction terms, and label these by the type of substance. 

```{r graph}
label_data <- UsadaNoFaults %>%
  # count up the sport and sanction_terms
  dplyr::count(sport, sanction_terms, sort = TRUE) %>% 
  # ungroup them
  dplyr::ungroup() %>%
  # join back to data
  dplyr::inner_join(x = ., y = UsadaNoFaults, 
                    by = c("sport", "sanction_terms")) %>% 
  # sort by n
  dplyr::arrange(desc(n)) %>% 
  # get the top 15 rows
  dplyr::slice(1:15)

UsadaNoFaults %>%
  # count up the sport and sanction_terms
  dplyr::count(sport, sanction_terms, sort = TRUE) %>% 
  # ungroup them
  dplyr::ungroup() %>%
  # top 5
  utils::head(5) %>% 
  # plot these by count and sport
  ggplot2::ggplot(aes(x = stats::reorder(sport, n), 
                      y = n, 
                      group = sanction_terms)) +
  ggplot2::geom_point(aes(color = sanction_terms, 
                          size = n), 
                      show.legend = FALSE) +
  ggrepel::geom_text_repel(data = label_data, 
                           aes(label = substance_reason, size = 2),
                           show.legend = FALSE) +
  ggplot2::labs(y = "Number of 'no fault or negligence' sanctions",
                x = NULL, 
                title = "Positive tests without consequences", 
                subtitle = "Top 5 sports, athletes, and substances with 'no fault or negligence' terms",
                caption = "source: https://www.usada.org/news/sanctions/") +
  ggplot2::coord_flip() +
  ggplot2::theme_classic(base_size = 9, 
                         base_family = "Ubuntu")
```

This looks like MMA and Track and Field lead the way in term of *no fault or negligence*, and most of these are [meldonium](https://en.wikipedia.org/wiki/Meldonium) and [clenbuterol.](https://en.wikipedia.org/wiki/Clenbuterol). 
