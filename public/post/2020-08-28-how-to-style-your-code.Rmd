---
title: How to style your code with styler
author: Martin Frigaard
date: '2020-08-28'
slug: how-to-style-your-code
categories:
  - Rmarkdown
tags: []
---

```{r setup, include=FALSE}
library(knitr)
# base options ----
base::options(
  tibble.print_max = 25,
  tibble.width = 78,
  scipen = 100000000,
  max.print = 999999
)
# knitr chunk options ----
knitr::opts_chunk$set(
  echo = TRUE, # show/hide all code
  tidy = FALSE, # cleaner code printing
  comment = "#> ", # better console printing
  eval = FALSE, # turn this to FALSE stop code chunks from running
  message = TRUE, # show messages
  fig.width = 7, # figure width
  fig.height = 5, # figure height
  warning = FALSE# show warnings
) # location of files
# knitr knit settings ----
knitr::opts_knit$set(
  width = 78
)
```

## TL:DR

If you're wondering how to style your code, check out the [`tidyverse` style guide](https://style.tidyverse.org/index.html). The [`styler` package](https://styler.r-lib.org/) has a great Addin for quickly styling files and directories. This post also covers a topic related to coding style (naming files), and I recommend checking out Jenny Bryan's [naming things talk](https://speakerdeck.com/jennybc/how-to-name-files).

## Why you should care about code style

To those of us writing code, our goal should be to write code that clearly and effectively communicates 1) what was done, and 2) what was created. There's an underlying narrative arc to every data analysis, and distilling that into something others can follow is an integral part of being a competent data scientist. Even for small, seemingly unimportant projects, we are always writing code for at least two people: future us and the computer running the code.

Programming style guides create consistency and minimizes the reader's confusion. By specifying and adhering to a style guide, we can provide a foundation for anyone who reads our code to 1) understand what we did to solve a particular problem, 2) if and where we ran into trouble, and 3) how we communicated the results. Coding style should also promote correct syntax and structure, so it's easier for the computer to execute.

### What code style should I follow?

[The tidyverse style guide](https://style.tidyverse.org/index.html) and [R For Data Science](https://r4ds.had.co.nz/) are excellent resources for writing precise, consistent code. In this post, we'll go over some additional packages that make coding styling easier and discuss customizing your coding style while maintaining brevity and clarity. Putting a style guide in place formalizes any ambiguity about *how* we're going to write our code, but leaves flexibility in *what* code we're going to write.

## An example project

Let's assume we have a project based on the excellent paper [Good enough practices in scientific computing](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510). We will create four folders like the ones described in [this section](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510#sec009). See the image below as an example:

![project layout](/post/2020-08-28-how-to-style-your-code_files/project-layout.png){width="80%"}

This project will use the video game sales datasets from Kaggle found [here](https://www.kaggle.com/ashaheedq/video-games-sales-2019). 

## The Packages

Below we add the packages we'll be using in this project.

```{r packages, message=FALSE, warning=FALSE, eval=TRUE}
library(tidyverse)
library(janitor)
library(styler)
library(inspectdf)
library(hrbrthemes)
```

## The Folders

The code chunk below create the necessary folders for this project, which we will call `goodenuff`. The [`tidyverse` style guide recommends](https://style.tidyverse.org/syntax.html#object-names) naming vectors using [snake case](https://en.wikipedia.org/wiki/Snake_case), and using nouns instead of verbs to define variable names.

### Naming vectors

Below we create the `project_folders` vector with `c()` and `<-`.

```{r project_folders}
# create vector of four folder folders
project_folders <- c("data/", "doc/", "results/", "src/")
```

We set up this project using the `fs` and `purrr` packages. Read more about how to use these functions [here](https://www.tidyverse.tips/post/file-management-with-fs/) and [here](https://purrr.tidyverse.org/).

First we set up the folders by defining a vector of folder names and using `purrr::map()` to iterate through them with `fs::dir_create()`. The `.x` argument in `purrr::map()` is the `project_folders` vector, and the second argument `.f` is function we'd like to pass to every item in `project_folders`. We also wrap everything in `purrr::quietly()` to reduce the output.

```{r map-project_folders}
# create project_folders vector
project_folders <- c("data/", "doc/", "results/", "src/")
# map project_folders to dir_create
quietly(map(.x = project_folders, .f = fs::dir_create))
```

We can see these folders have been created (note we're using `.Rproj` files here!)

```{r folders-check}
# check
fs::dir_tree(".")
# ├── data
# ├── doc
# ├── goodenuff.Rproj
# ├── results
# └── src
```

## The Files

Below we create script files for each step in a data analysis project (`import` -\> `tidy` -\> `transform` -\> `wrangle` -\> `model` -\> `communicate`), including a `runall.R` script that runs all six sequential files. All of these get stored in the `script_files` vector.

```{r map-script_files}
# create vector of script files
script_files <- c("src/01-import.R", "src/02-tidy.R", "src/03-wrangle.R", 
                  "src/04-visualize.R", "src/05-model.R", 
                  "src/06-communicate.R", "src/runall.R")
# map script files
quietly(map(.x = script_files, .f = fs::file_create))
# verify
fs::dir_tree("src")
```

```{r verify-r-scripts}
# src
# ├── 01-import.R
# ├── 02-tidy.R
# ├── 03-wrangle.R
# ├── 04-visualize.R
# ├── 05-model.R
# ├── 06-communicate.R
# └── runall.R
```

We want to [organize the script files](https://speakerdeck.com/jennybc/how-to-name-files?slide=19) in a way that clearly shows what we're doing at each step (and in which order they should be run).

### Dealing with long lines of code

Next we create the project files (note the correct directory in each file name). We can see there are seven files listed in [this section](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510#pcbi.1005510.box007) of the paper, and we can store these in the `project_files` vector.

```{r project_files}
# create project files vector
project_files <- c("CITATION", "README", "LICENSE", "requirements.txt", "doc/notebook.md", "doc/manuscript.md", "doc/changelog.txt")
```

Now we're facing a common problem when writing code: long lines. The style guide [recommends keeping line length to 80 characters](https://style.tidyverse.org/syntax.html#long-lines) because it makes it easier to print on the screen. We can set a ruler as a guide too by following the steps below:

![set a ruler for a guide!](/post/2020-08-28-how-to-style-your-code_files/set-ruler.png){width="80%"}

If we re-write this code ourselves, it might look like this:

```{r new-project_files}
project_files <- c("CITATION", "README", "LICENSE", "requirements.txt", 
                   "doc/notebook.md", "doc/manuscript.md", "doc/changelog.txt")
```

Now we can `map` this new vector to `fs::dir_create()` and check the new folder contents.

```{r map-project_files}
purrr::map(.x = project_files, .f = fs::file_create)
# check 
fs::dir_tree(".", recurse = TRUE)
```

And we end up with a project folder that looks like this:

```{r project_files-check}
# ├── CITATION
# ├── LICENSE
# ├── README
# ├── README.Rmd
# ├── data
# ├── doc
# │   ├── changelog.txt
# │   ├── manuscript.md
# │   └── notebook.md
# ├── goodenuff.Rproj
# ├── requirements.txt
# ├── results
# └── src
```

## The Data

These data come from [Kaggle and contain video game sales in 2019](https://www.kaggle.com/ashaheedq/video-games-sales-2019). We're only interested in the `vgsales-12-4-2019.csv` data file, which we can download [here](https://www.kaggle.com/ashaheedq/video-games-sales-2019?select=vgsales-12-4-2019.csv) and save in a sub-folder called, `data/raw/`.

```{r create-raw-data-folder}
# create a raw data folder
fs::dir_create("data/raw/")
# create a list of zipped files
zipped_files <- list.files("data/raw/", full.names = TRUE) 
# import the data into a data object
VideoGames <- map_df(.x = zipped_files, .f = read_csv)
```

```{r data-import-out}
# Multiple files in zip: reading 'vgsales-12-4-2019.csv'
# Parsed with column specification:
# cols(
#   .default = col_double(),
#   Name = col_character(),
#   basename = col_character(),
#   Genre = col_character(),
#   ESRB_Rating = col_character(),
#   Platform = col_character(),
#   Publisher = col_character(),
#   Developer = col_character(),
#   VGChartz_Score = col_logical(),
#   Last_Update = col_character(),
#   url = col_character(),
#   img_url = col_character()
# )
# See spec(...) for full column specifications.
```

### Naming data vs. everything else

I differ slightly from the [tidyverse style guide](https://style.tidyverse.org/syntax.html#object-names) when it comes to naming rectangular data objects (`tibble`s, `data.frame`s, `data.table`s, etc.) vs. non-rectangular objects (`vector`s, `list`s, `function`s, etc.).

```{r naming-data-vs-everything-else}
# how I name rectangular data:
#   DataFrames
#   Tibbles
#   DataTables
# how I name everything else:
#   vectors
#   lists
#   my_function()
```

I chose this method of naming because 80% or more of the time I am working with rectangular data, so I like to differentiate these objects from others in my current environment.

### Script file headers

R script file headers should give the reader 1) a description of the file and what the file does, 2) the last date it was updated, 3) the author and any contributors, and 4) the version number.

```{r script-headers}
#=====================================================================#
# File name: 01-import.R
# This is code to create: Importing video game data 
# Authored by and feedback to: @mjfrigaard
# Last updated: 2020-09-01
# MIT License
# Version: 0.1
#=====================================================================#
```

Read more about script file headers in [Reproducible Research with R and RStudio, 3rd Edition](https://www.routledge.com/Reproducible-Research-with-R-and-RStudio/Gandrud/p/book/9780367143985).

### Writing functions

We can also document the contents of our .R files with section headers, which we will create with a function titled, `add_script_section()`. This function has been adapted from [R for Data Science](https://r4ds.had.co.nz/functions.html#dot-dot-dot).

There are lots of tips on writing functions in the [tidyverse style guide](https://style.tidyverse.org/functions.html) and [R for Data Science](https://r4ds.had.co.nz/functions.html#functions-are-for-humans-and-computers), so we'll just cover the basics here:

1.  use verbs instead of nouns for function names\
2.  comments in your functions should *explain the "why" not the "what" or "how"*\
3.  use `snake_case` or `camelCase` (and be consistent)\
4.  strive for brevity and clarity (if you have to chose one, settle for the former)

```{r add_script_section}
add_script_section <- function(title = "", padding = "-") {
  # script sections help organize your code files  
  title <- paste0(title)
  width <- 75 - nchar(title)
  cat("# ", title, " ", stringr::str_dup(padding, width), "\n", sep = "")
}
```

When we use the `add_script_section()` function to create a section header, we see the following:

```{r use-script_section}
add_script_section(title = "Packages")
# Packages ------------------------------------------------------------
```

We can also use `=` for code sections. I like to create section headers in each `.R` file because it's easy to identify them in the RStudio source pane.

### Import data script

Other functions we might want to include in `01-import.R` include `janitor::clean_names()` or arguments passed to `readr::read_csv()` like `col_types` and `col_names`.

```{r clean-names}
# clean names 
VideoGames <- VideoGames %>% janitor::clean_names(case = "snake")
# verify
names(VideoGames)
```

```{r names-VideoGames-out}
#  [1] "rank"            "name"            "basename"        "genre"          
#  [5] "esrb_rating"     "platform"        "publisher"       "developer"      
#  [9] "vg_chartz_score" "critic_score"    "user_score"      "total_shipped"  
# [13] "global_sales"    "na_sales"        "pal_sales"       "jp_sales"       
# [17] "other_sales"     "year"            "last_update"     "url"            
# [21] "status"          "vgchartzscore"   "img_url"
```

When we're done, our `01-import.R` file should look like this,

```{r 01-import.R}
#=====================================================================#
# File name: 01-import.R
# This is code to create: Importing video game data 
# Authored by and feedback to: @mjfrigaard
# Last updated: 2020-09-01
# MIT License
# Version: 0.1
#=====================================================================#

# Packages ------------------------------------------------------------
library(tidyverse)
library(janitor)

# Import CSV file ------------------------------------------------------------
# source: https://www.kaggle.com/ashaheedq/video-games-sales-2019

# create a raw data folder
fs::dir_create("data/raw/")

# create a list of zipped files
zipped_files <- list.files("data/raw/", full.names = TRUE) 

# import the data into a data object
VideoGames <- map_df(.x = zipped_files, .f = read_csv)

# clean names 
VideoGames <- VideoGames %>% janitor::clean_names(case = "snake")
```

We can call this .R script using `source("src/01-import.R")`.

```{r source-01-import.R}
source("src/01-import.R")
```

```{r source-01-import.R-run, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#=====================================================================#
# File name: 01-import.R
# This is code to create: Importing video game data 
# Authored by and feedback to: @mjfrigaard
# Last updated: 2020-09-01
# MIT License
# Version: 0.1
#=====================================================================#

# Packages ------------------------------------------------------------
library(tidyverse)
library(janitor)

# Import CSV file ------------------------------------------------------------
# source: https://www.kaggle.com/ashaheedq/video-games-sales-2019

# create a raw data folder
fs::dir_create("data/raw/")

# create a list of zipped files
zipped_files <- list.files("data/raw/code-style/", full.names = TRUE) 

# import the data into a data object
VideoGames <- map_df(.x = zipped_files, .f = read_csv)

# clean names 
VideoGames <- VideoGames %>% janitor::clean_names(case = "snake")
```

### Style your code with `styler`

The [`styler` package](https://styler.r-lib.org/) has a handy Addin. If you have the `styler` package loaded, you can click on the **Addins** dropdown at the top of the Source pane and search for "style". 

![](/post/2020-08-28-how-to-style-your-code_files/styler-addin.png){width=100% height=100%}

Select "Style active file" and watch the magic happen.

![](https://media.giphy.com/media/t4HRrI6O6b4H3wBGNR/giphy.gif){width=120% height=120%}

It might take a little while, but you'll see your code styled automatically by RStudio. 

![](https://media.giphy.com/media/vb4LsK6bKoVp5NhFa9/giphy.gif){width=120% height=120%}

You can also add some tweaks to the `styler` package. I like the addon by Garrick Aden-Buie available [here](https://github.com/gadenbuie/grkstyle). After you've loaded the package, you can just run the `grkstyle::use_grk_style()` function and select "Style active file" again.

Here is an example of how it looks:

![](https://media.giphy.com/media/zUbvnacmxehPzI4Cgk/giphy.gif){width=120% height=120%}

You can see the code formatting is slightly different than the standard `tidyverse_style` (which is the default setting in `styler`).

![](https://media.giphy.com/media/Z70OI8XcVbHyzwTH1y/giphy.gif){width=120% height=120%}

I hope you found this post useful!